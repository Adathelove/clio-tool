#!/usr/bin/env bash
# update-locatedb - Manage macOS locate database updates
#
# Usage:
#   update-locatedb            # Run updatedb now
#   update-locatedb --install  # Install launchd service for weekly updates
#   update-locatedb --status   # Check if locate database exists and when last updated


SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLIST_NAME="com.user.locate.updatedb"
PLIST_PATH="${HOME}/Library/LaunchAgents/${PLIST_NAME}.plist"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}✓${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}⚠${NC} $*"
}

log_error() {
    echo -e "${RED}✗${NC} $*"
}

check_status() {
    echo "=== Locate Database Status ==="

    # Check if database exists
    if [ -f /var/db/locate.database ]; then
        log_info "Database exists: /var/db/locate.database"

        # Check last modified time
        if [[ "$OSTYPE" == "darwin"* ]]; then
            local last_update=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" /var/db/locate.database)
            echo "  Last updated: ${last_update}"
        fi

        # Check size
        local size=$(du -h /var/db/locate.database | cut -f1)
        echo "  Size: ${size}"
    else
        log_warn "Database does not exist: /var/db/locate.database"
        echo "  Run 'update-locatedb' to create it"
    fi

    echo ""
    echo "=== LaunchAgent Status ==="
    if [ -f "${PLIST_PATH}" ]; then
        log_info "LaunchAgent installed: ${PLIST_PATH}"
        if launchctl list | grep -q "${PLIST_NAME}"; then
            log_info "LaunchAgent is loaded"
        else
            log_warn "LaunchAgent is not loaded"
            echo "  Run: launchctl load ${PLIST_PATH}"
        fi
    else
        log_warn "LaunchAgent not installed"
        echo "  Run 'update-locatedb --install' to install"
    fi
}

run_updatedb() {
    echo "=== Updating locate database ==="
    log_info "This may take a few minutes and requires sudo privileges..."

    if sudo /usr/libexec/locate.updatedb; then
        log_info "Database updated successfully"
        check_status
    else
        log_error "Failed to update database"
        return 1
    fi
}

install_launchd() {
    echo "=== Installing LaunchAgent for automatic updates ==="

    # Create LaunchAgents directory if it doesn't exist
    mkdir -p "${HOME}/Library/LaunchAgents"

    # Create the plist file
    cat > "${PLIST_PATH}" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${PLIST_NAME}</string>

    <key>ProgramArguments</key>
    <array>
        <string>/usr/libexec/locate.updatedb</string>
    </array>

    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>3</integer>
        <key>Minute</key>
        <integer>0</integer>
        <key>Weekday</key>
        <integer>0</integer>
    </dict>

    <key>StandardOutPath</key>
    <string>${HOME}/Library/Logs/locate.updatedb.log</string>

    <key>StandardErrorPath</key>
    <string>${HOME}/Library/Logs/locate.updatedb.error.log</string>

    <key>RunAtLoad</key>
    <false/>
</dict>
</plist>
EOF

    log_info "Created ${PLIST_PATH}"
    log_info "Scheduled to run every Sunday at 3:00 AM"

    # Load the agent
    log_info "Loading LaunchAgent..."
    if launchctl load "${PLIST_PATH}" 2>/dev/null; then
        log_info "LaunchAgent loaded successfully"
    else
        log_warn "LaunchAgent might already be loaded or needs manual loading"
    fi

    echo ""
    log_info "To manually trigger an update, run: update-locatedb"
    log_info "To uninstall, run: launchctl unload ${PLIST_PATH} && rm ${PLIST_PATH}"
}

show_help() {
    cat <<EOF
Usage: update-locatedb [OPTIONS]

Manage macOS locate database updates.

OPTIONS:
    (no args)       Update the locate database now (requires sudo)
    --install       Install launchd service for automatic weekly updates
    --status        Check database status and launchd configuration
    --help          Show this help message

EXAMPLES:
    # Update database now
    update-locatedb

    # Install automatic weekly updates
    update-locatedb --install

    # Check status
    update-locatedb --status

NOTES:
    - The locate database is stored in /var/db/locate.database
    - Updates require sudo privileges
    - LaunchAgent runs weekly on Sundays at 3:00 AM
    - After updating, use 'locate' command to search for files

EOF
}

# Main script logic
main() {
    case "${1:-}" in
        --install)
            install_launchd
            ;;
        --status)
            check_status
            ;;
        --help|-h)
            show_help
            ;;
        "")
            run_updatedb
            ;;
        *)
            log_error "Unknown option: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
