#!/usr/bin/env bash
# search-onedrive - Search for keywords in OneDrive files
#
# Usage:
#   search-onedrive KEYWORD [--type FILETYPE]
#
# This searches ALL files in OneDrive, not just .agent.dir/Logs
# Used when you need to find work-related content outside of agent logs


# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

ONEDRIVE_PATH="${HOME}/Cloud/OneDrive-Sturdy"
KEYWORD=""
FILE_TYPE=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --type|-t)
            FILE_TYPE="$2"
            shift 2
            ;;
        --help|-h)
            cat <<EOF
Usage: search-onedrive KEYWORD [OPTIONS]

Search for keyword in all OneDrive files.

ARGUMENTS:
    KEYWORD         The keyword to search for

OPTIONS:
    --type TYPE     Limit to file type (e.g., md, txt, doc, pdf)
    --help          Show this help message

EXAMPLES:
    # Search for "API" in all files
    search-onedrive API

    # Search for "deployment" in markdown files
    search-onedrive deployment --type md

    # Search for "budget" in documents
    search-onedrive budget --type "doc*"

OUTPUT:
    Results with file path, match count, and context

EOF
            exit 0
            ;;
        *)
            KEYWORD="$1"
            shift
            ;;
    esac
done

if [ -z "$KEYWORD" ]; then
    echo -e "${RED}Error: KEYWORD required${NC}" >&2
    echo "Usage: search-onedrive KEYWORD [--type TYPE]" >&2
    exit 1
fi

if [ ! -d "$ONEDRIVE_PATH" ]; then
    echo -e "${RED}Error: OneDrive path not found: $ONEDRIVE_PATH${NC}" >&2
    exit 1
fi

echo -e "${BOLD}Searching OneDrive for: ${GREEN}$KEYWORD${NC}"
if [ -n "$FILE_TYPE" ]; then
    echo -e "${DIM}File type: $FILE_TYPE${NC}"
fi
echo -e "${DIM}Path: $ONEDRIVE_PATH${NC}"
echo ""

# Build find command
FIND_CMD="find \"$ONEDRIVE_PATH\" -type f"

if [ -n "$FILE_TYPE" ]; then
    FIND_CMD="$FIND_CMD -name \"*.$FILE_TYPE\""
fi

# Search for keyword
FOUND_COUNT=0

eval "$FIND_CMD" 2>/dev/null | while IFS= read -r file; do
    # Skip binary files and very large files
    local file_size=$(stat -f "%z" "$file" 2>/dev/null || echo "0")

    # Skip files larger than 10MB
    if [ "$file_size" -gt 10485760 ]; then
        continue
    fi

    # Check if file is likely text
    if file "$file" | grep -q "text"; then
        # Search for keyword
        if grep -q -i "$KEYWORD" "$file" 2>/dev/null; then
            FOUND_COUNT=$((FOUND_COUNT + 1))

            # Get relative path from OneDrive root
            local rel_path="${file#$ONEDRIVE_PATH/}"

            # Count matches
            local match_count=$(grep -c -i "$KEYWORD" "$file" 2>/dev/null || echo "0")

            echo -e "${CYAN}$rel_path${NC} ${DIM}($match_count matches)${NC}"

            # Show first few matching lines with context
            grep -i -n -C 1 --color=always "$KEYWORD" "$file" 2>/dev/null | head -10
            echo ""
        fi
    fi
done

if [ "$FOUND_COUNT" -eq 0 ]; then
    echo -e "${YELLOW}No matches found${NC}"
else
    echo -e "${GREEN}âœ“ Found matches in $FOUND_COUNT file(s)${NC}"
fi
