#!/usr/bin/env bash
# clio - Chronological Log Inspector and Observer
#
# Browse .agent.dir logs chronologically across your system
#
# Usage:
#   clio list [--from DATE] [--to DATE] [PATH]
#   clio show LOG_FILE
#   clio search PATTERN [PATH]
#   clio timeline [PATH]
#   clio refs LOG_FILE
#   clio interactive [PATH]


SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Check dependencies
check_jq() {
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}Error: jq is required but not installed.${NC}" >&2
        echo "Install with: brew install jq" >&2
        exit 1
    fi
}

# List all logs with optional date filtering
cmd_list() {
    local start_path="${1:-$HOME}"
    local from_date="${FROM_DATE:-}"
    local to_date="${TO_DATE:-}"
    local use_locate="${USE_LOCATE:-false}"

    check_jq

    local method_flag="--find"
    if [ "$use_locate" = "true" ]; then
        method_flag="--locate"
    fi

    # Get logs as JSON
    local logs=$("${SCRIPT_DIR}/find-agent-logs" $method_flag "$start_path")

    # Filter by date if specified
    if [ -n "$from_date" ] || [ -n "$to_date" ]; then
        local jq_filter='.'

        if [ -n "$from_date" ]; then
            jq_filter="$jq_filter | select(.date_from_name >= \"$from_date\")"
        fi

        if [ -n "$to_date" ]; then
            jq_filter="$jq_filter | select(.date_from_name <= \"$to_date\")"
        fi

        logs=$(echo "$logs" | jq -c "[.[] | $jq_filter]")
    fi

    # Sort by date
    logs=$(echo "$logs" | jq -c 'sort_by(.date_from_name, .modified_timestamp)')

    # Display results
    local count=$(echo "$logs" | jq 'length')

    if [ "$count" -eq 0 ]; then
        echo -e "${YELLOW}No logs found${NC}"
        return 0
    fi

    echo -e "${BOLD}Found $count log file(s)${NC}"
    echo ""

    echo "$logs" | jq -r '.[] |
        "\(.date_from_name // "no-date") | \(.project_dir | split("/") | last) | \(.path)"' | \
        while IFS='|' read -r date project path; do
            date=$(echo "$date" | xargs)
            project=$(echo "$project" | xargs)
            path=$(echo "$path" | xargs)

            # Color code by date
            local color=$GREEN
            if [ "$date" = "no-date" ]; then
                color=$DIM
            fi

            printf "${color}%-12s${NC} ${CYAN}%-30s${NC} ${DIM}%s${NC}\n" \
                "$date" "$project" "$path"
        done
}

# Show content of a specific log
cmd_show() {
    local log_file="$1"

    if [ ! -f "$log_file" ]; then
        echo -e "${RED}Error: File not found: $log_file${NC}" >&2
        exit 1
    fi

    # Show header with metadata
    echo -e "${BOLD}=== Log File ===${NC}"
    echo -e "${CYAN}Path:${NC} $log_file"

    if [[ "$OSTYPE" == "darwin"* ]]; then
        local mtime=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$log_file" 2>/dev/null)
        local size=$(stat -f "%z" "$log_file" 2>/dev/null)
    else
        local mtime=$(stat -c "%y" "$log_file" 2>/dev/null | cut -d'.' -f1)
        local size=$(stat -c "%s" "$log_file" 2>/dev/null)
    fi

    echo -e "${CYAN}Modified:${NC} $mtime"
    echo -e "${CYAN}Size:${NC} $size bytes"
    echo ""
    echo -e "${BOLD}=== Content ===${NC}"
    echo ""

    # Show content with line numbers
    cat -n "$log_file"
}

# Search for pattern in logs
cmd_search() {
    local pattern="$1"
    local start_path="${2:-$HOME}"
    local use_locate="${USE_LOCATE:-false}"

    check_jq

    local method_flag="--find"
    if [ "$use_locate" = "true" ]; then
        method_flag="--locate"
    fi

    local logs=$("${SCRIPT_DIR}/find-agent-logs" $method_flag "$start_path")

    echo -e "${BOLD}Searching for: ${GREEN}$pattern${NC}"
    echo ""

    local found=false

    echo "$logs" | jq -r '.[].path' | while IFS= read -r log_file; do
        if grep -l -i "$pattern" "$log_file" 2>/dev/null; then
            found=true
            local date=$(basename "$log_file" .md)

            echo -e "${CYAN}$date${NC} ${DIM}$log_file${NC}"

            # Show matching lines with context
            grep -i -n -C 2 --color=always "$pattern" "$log_file" 2>/dev/null | head -20
            echo ""
        fi
    done

    if [ "$found" = false ]; then
        echo -e "${YELLOW}No matches found${NC}"
    fi
}

# Show timeline view of logs
cmd_timeline() {
    local start_path="${1:-$HOME}"
    local use_locate="${USE_LOCATE:-false}"

    check_jq

    local method_flag="--find"
    if [ "$use_locate" = "true" ]; then
        method_flag="--locate"
    fi

    local logs=$("${SCRIPT_DIR}/find-agent-logs" $method_flag "$start_path")

    # Sort by date and group by project
    logs=$(echo "$logs" | jq -c 'sort_by(.date_from_name)')

    echo -e "${BOLD}=== Log Timeline ===${NC}"
    echo ""

    local current_date=""

    echo "$logs" | jq -r '.[] | "\(.date_from_name)|\(.project_dir)|\(.path)"' | \
        while IFS='|' read -r date project_path log_path; do
            local project=$(basename "$project_path")

            # Print date header if changed
            if [ "$date" != "$current_date" ]; then
                if [ -n "$current_date" ]; then
                    echo ""
                fi
                echo -e "${BOLD}${GREEN}$date${NC}"
                current_date="$date"
            fi

            # Count lines in log
            local line_count=$(wc -l < "$log_path" 2>/dev/null || echo "0")

            printf "  ${CYAN}%-30s${NC} ${DIM}(%4d lines)${NC} %s\n" \
                "$project" "$line_count" "$log_path"
        done
}

# Find references to other logs within a log file
cmd_refs() {
    local log_file="$1"

    if [ ! -f "$log_file" ]; then
        echo -e "${RED}Error: File not found: $log_file${NC}" >&2
        exit 1
    fi

    echo -e "${BOLD}=== References in: $(basename "$log_file") ===${NC}"
    echo ""

    # Look for date patterns that might reference other logs
    # Pattern: YYYY-MM-DD
    local date_refs=$(grep -o -E '[0-9]{4}-[0-9]{2}-[0-9]{2}' "$log_file" | sort -u)

    if [ -z "$date_refs" ]; then
        echo -e "${YELLOW}No date references found${NC}"
        return 0
    fi

    echo -e "${CYAN}Date references found:${NC}"
    echo "$date_refs" | while read -r date; do
        echo "  - $date"
    done

    echo ""
    echo -e "${CYAN}Potential related logs:${NC}"

    # Find logs matching these dates
    local parent_dir=$(dirname "$(dirname "$log_file")")

    for date in $date_refs; do
        local matching_log="${parent_dir}/.agent.dir/Logs/${date}.md"
        if [ -f "$matching_log" ] && [ "$matching_log" != "$log_file" ]; then
            echo -e "  ${GREEN}âœ“${NC} $matching_log"
        fi
    done
}

# Interactive mode
cmd_interactive() {
    local start_path="${1:-$HOME}"

    echo -e "${BOLD}${CYAN}Clio - Chronological Log Inspector${NC}"
    echo -e "${DIM}Type 'help' for commands, 'quit' to exit${NC}"
    echo ""

    while true; do
        echo -ne "${BOLD}clio>${NC} "
        read -r cmd args

        case "$cmd" in
            list|ls)
                cmd_list $args
                ;;
            show|cat)
                cmd_show $args
                ;;
            search|grep)
                cmd_search $args
                ;;
            timeline|tl)
                cmd_timeline $args
                ;;
            refs|references)
                cmd_refs $args
                ;;
            help|h|\?)
                show_help
                ;;
            quit|exit|q)
                echo "Goodbye!"
                exit 0
                ;;
            "")
                continue
                ;;
            *)
                echo -e "${RED}Unknown command: $cmd${NC}"
                echo "Type 'help' for available commands"
                ;;
        esac

        echo ""
    done
}

show_help() {
    cat <<EOF
${BOLD}Clio - Chronological Log Inspector and Observer${NC}

${BOLD}USAGE:${NC}
    clio <command> [options] [arguments]

${BOLD}COMMANDS:${NC}
    ${GREEN}list${NC} [PATH]              List all logs chronologically
    ${GREEN}show${NC} LOG_FILE            Show content of a specific log
    ${GREEN}search${NC} PATTERN [PATH]    Search for pattern across logs
    ${GREEN}timeline${NC} [PATH]          Show timeline view grouped by date
    ${GREEN}refs${NC} LOG_FILE            Find references to other logs
    ${GREEN}interactive${NC} [PATH]       Enter interactive mode
    ${GREEN}help${NC}                     Show this help message

${BOLD}OPTIONS:${NC}
    --from DATE               Filter logs from date (YYYY-MM-DD)
    --to DATE                 Filter logs to date (YYYY-MM-DD)
    --locate                  Use locate database (faster)
    --find                    Use find command (slower, more current)

${BOLD}EXAMPLES:${NC}
    # List all logs from home directory
    clio list

    # List logs from a specific project
    clio list ~/repos/my-project

    # List logs from January 2026
    clio list --from 2026-01-01 --to 2026-01-31

    # Show specific log
    clio show ~/.agent.dir/Logs/2026-01-23.md

    # Search for "SUCCESS" across all logs
    clio search SUCCESS

    # View timeline
    clio timeline

    # Find referenced logs
    clio refs ~/.agent.dir/Logs/2026-01-23.md

    # Enter interactive mode
    clio interactive

${BOLD}INTERACTIVE MODE COMMANDS:${NC}
    list, ls              - List logs
    show FILE             - Show log content
    search PATTERN        - Search logs
    timeline, tl          - Timeline view
    refs FILE             - Show references
    help, h, ?            - Show help
    quit, exit, q         - Exit

${BOLD}NOTES:${NC}
    - Logs are found in .agent.dir/Logs/ directories
    - Date format is YYYY-MM-DD
    - Use --locate after running 'update-locatedb' for faster searches
    - Interactive mode remembers your current path

EOF
}

# Parse global options
USE_LOCATE=false
FROM_DATE=""
TO_DATE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --locate)
            USE_LOCATE=true
            shift
            ;;
        --find)
            USE_LOCATE=false
            shift
            ;;
        --from)
            FROM_DATE="$2"
            shift 2
            ;;
        --to)
            TO_DATE="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Export for subcommands
export USE_LOCATE
export FROM_DATE
export TO_DATE

# Main command dispatch
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    list|ls)
        cmd_list "$@"
        ;;
    show|cat)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: LOG_FILE required${NC}" >&2
            exit 1
        fi
        cmd_show "$@"
        ;;
    search|grep)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: PATTERN required${NC}" >&2
            exit 1
        fi
        cmd_search "$@"
        ;;
    timeline|tl)
        cmd_timeline "$@"
        ;;
    refs|references)
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: LOG_FILE required${NC}" >&2
            exit 1
        fi
        cmd_refs "$@"
        ;;
    interactive|i)
        cmd_interactive "$@"
        ;;
    help|h|\?)
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command: $COMMAND${NC}" >&2
        echo ""
        show_help
        exit 1
        ;;
esac
